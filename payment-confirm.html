<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Payment Proof - Brew & Bites CafÃ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #8B4513;
            --secondary: #D2691E;
            --accent: #F4A460;
        }

        .upload-area {
            transition: all 0.3s ease;
            border: 2px dashed #d1d5db;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background-color: #fef7ed;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background-color: #fef3e2;
            transform: scale(1.02);
        }

        .image-preview {
            transition: all 0.3s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-amber-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex justify-center items-center mb-4">
                <i class="fas fa-coffee text-4xl text-amber-600 mr-3"></i>
                <h1 class="text-4xl font-bold text-gray-800">Brew & Bites CafÃ©</h1>
            </div>
            <p class="text-gray-600 text-lg">Upload your payment receipt screenshot</p>
        </header>

        <!-- Payment Confirmation Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 slide-in">
            <!-- Order Summary -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-receipt mr-3 text-amber-600"></i>
                    Order Summary
                </h2>
                
                <div id="order-details" class="bg-gray-50 rounded-xl p-4">
                    <!-- Order details will be loaded here -->
                </div>
            </div>

            <!-- Upload Section -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-camera mr-3 text-amber-600"></i>
                    Upload Payment Proof
                </h3>
                
                <div class="upload-area rounded-xl p-8 text-center cursor-pointer transition-all duration-300"
                     id="upload-area">
                    <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-600 mb-2 font-medium">Click to upload payment screenshot</p>
                    <p class="text-sm text-gray-500">Supported formats: JPG, PNG, GIF (Max 5MB)</p>
                    <input type="file" id="screenshot-upload" accept="image/*" class="hidden">
                    <div class="mt-4 text-xs text-gray-400">
                        <p>ðŸ“± Take screenshot from your banking app</p>
                        <p>ðŸ’³ Make sure amount and date are visible</p>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="preview-section" class="hidden mt-6 slide-in">
                    <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-image mr-2 text-green-600"></i>
                        Preview:
                    </h4>
                    <div class="relative inline-block">
                        <img id="image-preview" class="max-w-full h-64 rounded-xl border-2 border-gray-200 shadow-sm object-cover">
                        <button onclick="removeImage()" 
                                class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm shadow-lg hover:bg-red-600 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2 text-center">Click the X button to remove and upload another image</p>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user mr-3 text-amber-600"></i>
                    Your Information
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Your Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="customer-name" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                               placeholder="Enter your full name" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Phone Number <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" id="customer-phone" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                               placeholder="+60 12-345 6789" required>
                        <p class="text-xs text-gray-500 mt-1">We'll notify you when your order is ready</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Payment Reference (Optional)
                        </label>
                        <input type="text" id="payment-reference" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
                               placeholder="Transaction ID, reference number, or note">
                        <p class="text-xs text-gray-500 mt-1">Helpful for verifying your payment</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button onclick="goBackToPayment()" 
                        class="flex-1 bg-gray-500 text-white py-4 rounded-xl font-bold hover:bg-gray-600 transition flex items-center justify-center space-x-2">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Payment</span>
                </button>
                <button onclick="submitPaymentProof()" id="submit-btn"
                        class="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <i class="fas fa-paper-plane"></i>
                    <span>Submit Proof</span>
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6">
            <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                How to take a good screenshot:
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">1</div>
                    <p class="text-blue-700">Open your banking/eWallet app</p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">2</div>
                    <p class="text-blue-700">Go to transaction history</p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">3</div>
                    <p class="text-blue-700">Take screenshot of successful payment</p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mt-1 flex-shrink-0">4</div>
                    <p class="text-blue-700">Make sure amount and date are visible</p>
                </div>
            </div>
            <div class="mt-4 p-3 bg-white rounded-lg border border-blue-100">
                <p class="text-sm text-blue-600 font-medium">ðŸ’¡ Tip: Make sure the screenshot shows:</p>
                <ul class="text-sm text-blue-600 mt-1 list-disc list-inside space-y-1">
                    <li>Payment amount matching your order total</li>
                    <li>Transaction date and time</li>
                    <li>Merchant name (Brew & Bites CafÃ©)</li>
                    <li>Transaction/Reference number</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md text-center transform transition-all duration-300 scale-95">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-green-600 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">Proof Submitted!</h3>
            <p class="text-gray-600 mb-2">Thank you for your payment proof.</p>
            <p class="text-gray-600 mb-2">We'll verify your payment and prepare your order.</p>
            <p class="text-sm text-gray-500 mb-6">You'll receive a notification when your order is ready.</p>
            <div class="space-y-3">
                <button onclick="goBackToMenu()" 
                        class="w-full bg-amber-600 text-white py-4 rounded-xl font-bold hover:bg-amber-700 transition">
                    Back to Menu
                </button>
                <button onclick="viewOrderStatus()" 
                        class="w-full bg-gray-500 text-white py-4 rounded-xl font-bold hover:bg-gray-600 transition">
                    Track My Order
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="loading-spinner w-12 h-12 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">Submitting your payment proof...</p>
            <p class="text-sm text-gray-500 mt-2">Please don't close this window</p>
        </div>
    </div>

    <script>
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        
        let uploadedImage = null;
        let currentOrder = null;

        // Load order details
        async function loadOrderDetails() {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentOrder = result.data;
                    displayOrderDetails(currentOrder);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error loading order:', error);
                displayOrderDetails({
                    orderId: orderId,
                    total: parseFloat(urlParams.get('total')) || 0,
                    customerName: 'Customer'
                });
            }
        }

        function displayOrderDetails(order) {
            const orderDetailsHtml = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${order.orderId}</h3>
                        <p class="text-gray-600">${order.customerName || 'Customer'}</p>
                        ${order.tableNumber ? `<p class="text-sm text-gray-500">${order.tableNumber}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-green-600">RM${order.total?.toFixed(2) || '0.00'}</div>
                        <p class="text-sm text-gray-500">Total Amount</p>
                    </div>
                </div>
                ${order.items && order.items.length > 0 ? `
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-2">Order Items:</h4>
                    <div class="space-y-1">
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm">
                                <span>${item.quantity}x ${item.name}</span>
                                <span>RM${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('order-details').innerHTML = orderDetailsHtml;
        }

        // Upload functionality
        function setupUploadHandlers() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('screenshot-upload');

            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
        }

        function handleFileSelection(file) {
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large! Please select an image under 5MB.');
                return;
            }

            // Check file type
            if (!file.type.match('image.*')) {
                alert('Please select an image file (JPG, PNG, GIF)');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImage = e.target.result;
                document.getElementById('image-preview').src = uploadedImage;
                document.getElementById('preview-section').classList.remove('hidden');
                document.getElementById('upload-area').classList.add('hidden');
                checkFormValidity();
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImage = null;
            document.getElementById('screenshot-upload').value = '';
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('upload-area').classList.remove('hidden');
            checkFormValidity();
        }

        function checkFormValidity() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const hasImage = uploadedImage !== null;
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = !(name && phone && hasImage);
        }

        // Form validation
        document.getElementById('customer-name').addEventListener('input', checkFormValidity);
        document.getElementById('customer-phone').addEventListener('input', checkFormValidity);

        // Submit payment proof
        async function submitPaymentProof() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const reference = document.getElementById('payment-reference').value.trim();

            if (!name || !phone || !uploadedImage) {
                alert('Please fill all required fields and upload payment proof.');
                return;
            }

            // Show loading state
            const loadingOverlay = document.getElementById('loading-overlay');
            const submitBtn = document.getElementById('submit-btn');
            
            loadingOverlay.classList.remove('hidden');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Submitting...</span>';
            submitBtn.disabled = true;

            try {
                // Submit payment proof
                const proofResponse = await fetch('/api/payment-proofs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        customerName: name,
                        customerPhone: phone,
                        paymentReference: reference,
                        screenshot: uploadedImage
                    })
                });

                const proofResult = await proofResponse.json();

                if (!proofResult.success) {
                    throw new Error(proofResult.error);
                }

                // Update order payment status
                const orderResponse = await fetch(`/api/orders/${orderId}/payment`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentStatus: 'pending_verification',
                        paymentMethod: 'qr_screenshot',
                        customerPhone: phone
                    })
                });

                const orderResult = await orderResponse.json();

                if (!orderResult.success) {
                    console.warn('Order update failed, but proof was submitted');
                }

                // Show success modal
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    document.getElementById('success-modal').classList.remove('hidden');
                    setTimeout(() => {
                        document.querySelector('#success-modal > div').classList.remove('scale-95');
                    }, 10);
                }, 1000);

            } catch (error) {
                console.error('Submission error:', error);
                loadingOverlay.classList.add('hidden');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span>Submit Proof</span>';
                submitBtn.disabled = false;
                
                alert('Failed to submit payment proof. Please try again. Error: ' + error.message);
            }
        }

        // Navigation
        function goBackToPayment() {
            window.location.href = `/payment/${orderId}`;
        }

        function goBackToMenu() {
            window.location.href = '/';
        }

        function viewOrderStatus() {
            window.location.href = `/admin/orders`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOrderDetails();
            setupUploadHandlers();
            
            // Auto-focus customer name field
            setTimeout(() => {
                document.getElementById('customer-name').focus();
            }, 500);
        });
    </script>
</body>
</html>