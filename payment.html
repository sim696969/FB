<script>
    // Get order ID from URL
    const orderId = window.location.pathname.split('/').pop();
    
    let currentOrder = null;

    // Load order details
    async function loadOrderDetails() {
        try {
            console.log('üîç Loading order:', orderId);
            
            const response = await fetch(`/api/orders/${orderId}`);
            const result = await response.json();
            
            if (result.success && result.data) {
                currentOrder = result.data;
                console.log('‚úÖ Order loaded:', currentOrder);
                displayOrderDetails(currentOrder);
            } else {
                throw new Error(result.error || 'Order not found');
            }
        } catch (error) {
            console.error('‚ùå Error loading order:', error);
            displayErrorState(error.message);
        }
    }

    function displayOrderDetails(order) {
        const orderDetailsHtml = `
            <div class="space-y-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${order.orderId || order.id}</h3>
                        <p class="text-gray-600">${order.customerName || 'Customer'}</p>
                        ${order.tableNumber ? `<p class="text-sm text-gray-500">School ID: ${order.tableNumber}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-amber-600">RM${order.total?.toFixed(2)}</div>
                        ${order.tipAmount > 0 ? `
                            <div class="text-sm text-gray-500">
                                Tip: RM${order.tipAmount.toFixed(2)}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">Order Items</h4>
                    ${order.items && order.items.length > 0 ? order.items.map(item => `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                            <div class="flex items-center space-x-3">
                                ${item.image ? `
                                    <img src="/picture/${item.image}" alt="${item.name}" 
                                         class="w-12 h-12 object-cover rounded-lg"
                                         onerror="this.style.display='none'">
                                ` : ''}
                                <div>
                                    <div class="font-medium text-gray-800">${item.quantity}x ${item.name}</div>
                                    <div class="text-sm text-gray-500">RM${item.price.toFixed(2)} each</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-800">RM${(item.quantity * item.price).toFixed(2)}</div>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-500 text-center py-4">No items found</p>'}
                </div>
                ${order.specialInstructions ? `
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <h4 class="font-semibold text-amber-800 mb-1">Special Instructions</h4>
                    <p class="text-amber-700 text-sm">${order.specialInstructions}</p>
                </div>
                ` : ''}
                <div class="border-t pt-4">
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total Amount:</span>
                        <span class="text-amber-600">RM${order.total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('order-details').innerHTML = orderDetailsHtml;
        document.getElementById('payment-amount').textContent = `RM${order.total.toFixed(2)}`;
        document.getElementById('instruction-amount').textContent = `RM${order.total.toFixed(2)}`;
    }

    function displayErrorState(errorMessage) {
        document.getElementById('order-details').innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                <p class="text-lg font-semibold mb-2">Order Not Found</p>
                <p class="text-sm text-gray-500">${errorMessage || 'Please check your order ID or contact staff'}</p>
                <p class="text-xs text-gray-400 mt-2">Order ID: ${orderId}</p>
                <button onclick="location.reload()" class="mt-4 bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition">
                    <i class="fas fa-refresh mr-2"></i>Try Again
                </button>
            </div>
        `;
    }

    // Mark order as paid
    async function markAsPaid(paymentMethod) {
        try {
            const response = await fetch(`/api/orders/${orderId}/payment`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paymentStatus: 'paid',
                    paymentMethod: paymentMethod
                })
            });

            const result = await response.json();

            if (result.success) {
                showSuccessModal();
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Payment error:', error);
            alert('Failed to update payment status: ' + error.message);
        }
    }

    function showSuccessModal() {
        document.getElementById('success-modal').classList.remove('hidden');
    }

    // Navigation functions
    function goToPaymentConfirmation() {
        if (currentOrder) {
            window.location.href = `/payment-confirm?orderId=${orderId}`;
        } else {
            window.location.href = `/payment-confirm?orderId=${orderId}`;
        }
    }

    function goBackToMenu() {
        window.location.href = '/';
    }

    function viewOrderStatus() {
        window.location.href = `/admin/orders`;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadOrderDetails);
</script>